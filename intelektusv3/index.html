<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ–ª–µ–∫—Ç—É—Å v2.193</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="menu">
        <img src="logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" id="logo">
        <div class="button-container">
            <img src="https://intelektus.ru/img_id_1.png" alt="–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å">
            <button onclick="showLayer('question')">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</button>
        </div>
        <div class="button-container">
            <img src="https://intelektus.ru/img_id_2.png" alt="–ü—Ä–æ—Ñ–∏–ª—å">
            <button onclick="showLayer('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
        <div class="button-container">
            <img src="https://intelektus.ru/img_id_3.png" alt="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">
            <button onclick="sendEmail()">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
        </div>
    </div>
    <div id="question" class="hidden">
        <img src="logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" id="logo">
        <p class="blue-box">–ó–∞–¥–∞–≤–∞–π –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å —è –ø–æ–º–æ–≥—É —Ç–µ–±–µ!</p>
        <div class="switch">
            <button class="text-switch">
                <p class="text-icon">ùêì</p>
                <p>–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç</p>
            </button>
            <button class="camera-switch" onclick="showLayer('cameralayer')">
                <img src="camera.svg">
                <p>–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</p>
            </button>
        </div>
        <div class="input-container">
            <textarea id="userQuestion" maxlength="5000" class="text-box" placeholder="–ü–æ–ª–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:"></textarea>
            <div class="tools">
                <div id="counter">0/5000</div>
                <img src="copy.svg" onclick="copyText()">
            </div>
            <p id="remainingRequests"></p>
            <button class="purple-button" onclick="submitQuestion(event)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <button class="back" onclick="showLayer('menu')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
    </div>
    <div id="question2" class="hidden">
        <img src="logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" id="logo">
        <button class="camera" onclick="showLayer('cameralayer')">
            <img src="camera.svg">
            <p>–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</p>
        </button>
        <div class="input-container">
            <textarea id="userQuestion2" maxlength="5000" class="text-box" placeholder="–ü–æ–ª–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:"></textarea>
            <div class="tools">
                <div id="counter2">0/5000</div>
                <img src="copy.svg" onclick="copyText2()">
            </div>
            <p id="remainingRequests2"></p>
            <button class="purple-button" onclick="submitQuestion2(event)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <button class="back" onclick="showLayer('menu')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
        <a id="imageLink" class="hidden" href="" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ</a>
    </div>
    <div id="reply" class="hidden">
        <img src="logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" id="logo">
        <p class="blue-box">–í–æ—Ç –º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å!</p>
        <textarea id="replyText" class="text-box" readonly></textarea>
        <div class="copyTool">
            <img class="copyIcon" src="copy.svg" onclick="copyReply()">
        </div>
        <button class="purple-button" onclick="continueChat()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä</button>
        <button class="back" onclick="showLayer('menu')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
    </div>
    <div id="profile" class="hidden">
        <img src="logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" id="logo">
        <div id="premiumStatus"></div>
        <div id="premiumBox"></div>
        <div id="premiumContainer"></div>
        <button class="back" onclick="showLayer('menu')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
    </div>
    <div id="loading" class="hidden">
        <div class="loader"></div>
        <h1>–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤ —Å—Ä–µ–¥–Ω–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç 20 —Å–µ–∫—É–Ω–¥, –Ω–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ –º–∏–Ω—É—Ç—ã.</p>
    </div>
    <div id="cameralayer" class="hidden">
        <img src="logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" id="logo">
        <p class="blue-box">–ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å–æ —Å–≤–æ–∏–º –≤–æ–ø—Ä–æ—Å–æ–º</p>
        <div class="switch">
            <button class="text-switch1" onclick="openText()">
                <p class="text-icon">ùêì</p>
                <p>–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç</p>
            </button>
            <button class="camera-switch1" onclick="showLayer('cameralayer')">
                <img src="camera.svg">
                <p>–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</p>
            </button>
        </div>
        <label for="file" class="custom-file-upload">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
        <input type="file" id="file" onchange="selected()">
        <div id="error"><p></p></div>
        <button class="purple-button" id="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
    </div>
    <script>

        const submit = document.getElementById('submit');
        const error = document.getElementById('error');
        const fileTypes = [
            "image/apng",
            "image/bmp",
            "image/gif",
            "image/jpeg",
            "image/pjpeg",
            "image/png",
            "image/svg+xml",
            "image/tiff",
            "image/webp",
            "image/x-icon",
        ];

        let tg;
        
        let chatId = null;
        let chatId2 = null;
        let idTg;
        let continueConversation = false;
        
        function showAlert(message) {
            window.Telegram.WebApp.showAlert(message);
        }
        
        document.addEventListener('DOMContentLoaded', function(){
            console.log(localStorage.getItem('question') == true);
            if(localStorage.getItem('question') == 'true'){
                showLayer('question');
                localStorage.clear();
            }
        })
        //—Å–Ω—è—Ç–∏–µ —Ñ–æ–∫—É—Å–∞ —Å imput field –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ
        document.addEventListener('click', function(event) {
            var inputElement = document.getElementById('userQuestion');
            if (event.target !== inputElement) {
                inputElement.blur();
            }
        });
        
        const messageEle = document.getElementById('userQuestion');
        const counterEle = document.getElementById('counter');

        messageEle.addEventListener('input', function (e) {
            const target = e.target;
            const maxLength = target.getAttribute('maxlength');
            const currentLength = target.value.length;
            counterEle.innerHTML = `${currentLength}/${maxLength}`;
        });

        const messageEle2 = document.getElementById('userQuestion2');
        const counterEle2 = document.getElementById('counter2');

        messageEle2.addEventListener('input', function (e) {
            const target = e.target;
            const maxLength = target.getAttribute('maxlength');
            const currentLength = target.value.length;
            counterEle2.innerHTML = `${currentLength}/${maxLength}`;
        });
        document.addEventListener('DOMContentLoaded', (event) => {

           // –ü–æ–ª—É—á–∞–µ–º IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
            fetch('https://api.ipify.org?format=json')
              .then(response => response.json())
              .then(data => {
                const ip = data.ip;
            
                // –ï—Å–ª–∏ IP-–∞–¥—Ä–µ—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–º—É, –Ω–µ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
                if (ip === "217.164.167.171") {
                  return;
                }
            
                // –í–∞—à –∫–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É
                fetch('https://intelektusrv.ru:8000/srv_status', {
                  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –≤ 10 —Å–µ–∫—É–Ω–¥
                  timeout: 10000
                })
                .then(response => response.json())
                .then(data => {
                  if (data.status !== "working") {
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    hideAll();
                    const warningDiv = document.createElement('div');
                    warningDiv.id = 'serverWarning';
                    warningDiv.innerHTML = `<p>–°–µ—Ä–≤–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</p><p>–ü—Ä–∏—á–∏–Ω–∞: ${data.reason}</p>`;
                    document.body.appendChild(warningDiv);
                  }
                })
                .catch(error => {
                  const warningDiv = document.createElement('div');
                  warningDiv.id = 'serverWarning';
            
                  if (error.name === 'AbortError') {
                    hideAll();
                    warningDiv.innerHTML = '<p>–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç</p><p>–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –ø–æ—á–∏–Ω–∏–º</p>';
                  } else {
                    hideAll();
                    warningDiv.innerHTML = `<p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</p><p>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${error.message}</p>`;
                  }
            
                  document.body.appendChild(warningDiv);
                });
              })
              .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ IP-–∞–¥—Ä–µ—Å–∞:", error);
              });
            
            let tg = window.Telegram.WebApp;
            
            idTg = tg.initDataUnsafe.user.id;
            tg.expand();
            console.log("idTg", idTg);

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            let viewportHeight = tg.viewportHeight;
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã—Å–æ—Ç—ã —Å–ª–æ—è –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('loading').style.height = viewportHeight + 'px';
            
        });

        const startChat = () => {
            console.log('–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞, —Å–æ–∑–¥–∞–Ω–∏–µ chatId...');
            console.log('https://intelektusrv.ru:8000/start_chat/' + idTg);
            fetch('https://intelektusrv.ru:8000/start_chat/' + idTg, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                console.log('startChat response:', data);
                if (data.status !== "failed") {
                    chatId = data.chat_id;
                    fetchRemainingRequests();
                } else if (data.status == "failed" && data.reason == "No remaining requests") {
                    showAlert("–Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–æ—Ñ–∏–ª—å");
                }
            })
            .catch((error) => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        };

        const startChat2 = () => {
            console.log('–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞, —Å–æ–∑–¥–∞–Ω–∏–µ chatId...');
            fetch('https://intelektusrv.ru:8000/start_chat/' + idTg, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                console.log('startChat response:', data);
                if (data.status !== "failed") {
                    chatId2 = data.chat_id;
                    fetchRemainingRequests2();
                } else if (data.status == "failed" && data.reason == "No remaining requests") {
                    showAlert("–Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–æ—Ñ–∏–ª—å");
                }
            })
            .catch((error) => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        };

        const fetchRemainingRequests = () => {
            fetch(`https://intelektusrv.ru:8000/remaining_requests/${idTg}`, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    document.getElementById('remainingRequests').innerText = `–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã: ${data.remainingRequests}`;
                }
            })
            .catch((error) => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        };

        const fetchRemainingRequests2 = () => {
            fetch(`https://intelektusrv.ru:8000/remaining_requests/${idTg}`, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    document.getElementById('remainingRequests2').innerText = `–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã: ${data.remainingRequests}`;
                }
            })
            .catch((error) => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        };

        const fetchPremiumStatus = () => {
            const premiumStatusElement = document.getElementById('premiumStatus');
            const premiumBox = document.getElementById('premiumBox');
            const premiumContainer = document.getElementById('premiumContainer');
            fetch(`https://intelektusrv.ru:8000/premium_end_date/${idTg}`, {
                method: 'POST',
            })
            .then(response => {
                console.log(response); // –í—ã–≤–æ–¥–∏—Ç –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
                return response.json();
            })
            .then(data => {
                console.log(data);
                if (data.status === "success") {
                    if (data.reason === "User is not premium" || data.premium_end_date === "expired") {
                        premiumStatusElement.innerHTML = '<p class="blue-box">–ü–æ—Ö–æ–∂–µ —á—Ç–æ —É —Ç–µ–±—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ :(</p>';
                        premiumBox.classList.add("noSub");
                        premiumBox.innerHTML = '<p>–ü–æ–¥–ø–∏—Å–∫–∞</p><img src="flash-off.svg" class="icon">'
                        premiumContainer.innerHTML = '<p class="blue-box">–ù–µ —Ä–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è, —Ç—ã –º–æ–∂–µ—à—å –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Å–µ–≥–æ –∑–∞ 1 –º–∏–Ω—É—Ç—É! </p><button id="buyPremium" class="purple-button">–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>';
                        document.getElementById('buyPremium').addEventListener('click', () => {
                            window.location.href = 'https://intelektus.ru/pay?user=' + idTg;
                        });
                    } else if (data.premium_end_date) {
                        
                        premiumStatusElement.innerHTML = '<p class="blue-box">–ü–æ–∑–¥—Ä–∞–≤–ª—è—é, —É —Ç–µ–±—è –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞!</p>';
                        premiumBox.classList.add("sub");
                        premiumBox.innerHTML = '<p>–ü–æ–¥–ø–∏—Å–∫–∞</p><img src="lightning-filled.svg"  class="icon">'
                        
                        isCharginAvailableVar = isCharginAvailable();
                        if (isCharginAvailableVar == "true"){
                            premiumContainer.innerHTML = `<p class="date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ${data.premium_end_date}</p><p class="blue-box">–ü–æ–º–Ω–∏: —Ç—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—à—å –ø—Ä–æ–¥–ª–∏—Ç—å —Å–≤–æ—é –ø–æ–¥–ø–∏—Å–∫—É –∑–∞—Ä–∞–Ω–µ–µ!</p><button id="extendPremium" class="purple-button">–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button><button class="red-button" onclick="cancelPremium()">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>`;
                        }
                        else{
                            premiumContainer.innerHTML = `<p class="date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ${data.premium_end_date}</p><p class="blue-box">–ü–æ–º–Ω–∏: —Ç—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—à—å –ø—Ä–æ–¥–ª–∏—Ç—å —Å–≤–æ—é –ø–æ–¥–ø–∏—Å–∫—É –∑–∞—Ä–∞–Ω–µ–µ!</p><button id="extendPremium" class="purple-button">–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>`;
                        }
                        document.getElementById('extendPremium').addEventListener('click', () => {
                            window.location.href = 'https://intelektus.ru/pay?user=' + idTg;
                        });
                    }
                }
                else if (data.status === "failed") {
                    showAlert("–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—É–ø–µ–Ω - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <–≤–µ—Ä–Ω—É—Ç—Å—è>");
                }
                else {
                    console.error(data.reason);
                }
            })    
        }

        const copyText = () => {
            const element = document.querySelector('#userQuestion');
            element.select();
            element.setSelectionRange(0, 999999);
            document.execCommand('copy');
        }

        const copyText2 = () => {
            const element = document.querySelector('#userQuestion2');
            element.select();
            element.setSelectionRange(0, 999999);
            document.execCommand('copy');
        }

        const copyReply = () => {
            const element = document.querySelector('#replyText');
            element.select();
            element.setSelectionRange(0, 999999);
            document.execCommand('copy');
        }

        const submitQuestion = (event) => {
            event.preventDefault();
            const message = document.getElementById('userQuestion').value.trim();
            document.getElementById('userQuestion').blur();
            if (message && message.length <= 5000) {
                document.getElementById('userQuestion').blur();
                showLayer('loading');
                fetch(`https://intelektusrv.ru:8000/send_message/${chatId}/${idTg}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: "user",
                        content: message,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('submitQuestion response:', data);
                    if (data.status !== "failed") {
                        document.getElementById('replyText').innerText = data.message;
                        document.getElementById('userQuestion').value = '';
                        showLayer('reply');
                    } else if (data.status == "failed" && data.reason == "No remaining requests") {
                        showAlert("–Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–æ—Ñ–∏–ª—å");
                    } else if (data.status == "failed" && data.reason == "Chat not found") {
                        showAlert("—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–æ—Ñ–∏–ª—å");
                        showLayer('menu');
                    }
                })
                .catch((error) => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                });
            } else if (message.length >= 5000) {
                showAlert("—Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ || –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –±–æ–ª—å—à–µ 5000 —Å–∏–º–≤–æ–ª–æ–≤");
            } else {
                showAlert("—Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
            }
        };

        const submitQuestion2 = (event) => {
            event.preventDefault();
            const message = document.getElementById('userQuestion2').value.trim();
            document.getElementById('userQuestion2').blur();
            if (message && message.length <= 5000) {
                document.getElementById('userQuestion2').blur();
                showLayer('loading');
                fetch(`https://intelektusrv.ru:8000/send_message/${chatId2}/${idTg}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: "user",
                        content: message,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('submitQuestion response:', data);
                    if (data.status !== "failed") {
                        document.getElementById('replyText').innerText = data.message;
                        document.getElementById('userQuestion2').value = '';
                        showLayer('reply');
                    } else if (data.status == "failed" && data.reason == "No remaining requests") {
                        showAlert("–Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–æ—Ñ–∏–ª—å");
                    } else if (data.status == "failed" && data.reason == "Chat not found") {
                        showAlert("—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–æ—Ñ–∏–ª—å");
                        showLayer('menu');
                    }
                })
                .catch((error) => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                });
            } else if (message.length >= 5000) {
                showAlert("—Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ || –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –±–æ–ª—å—à–µ 5000 —Å–∏–º–≤–æ–ª–æ–≤");
            } else {
                showAlert("—Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
            }
        };

        const continueChat = () => {
            continueConversation = true;
            showLayer('question');
        };

        function showLayer(layerId) {
            hideAll();
            document.getElementById(layerId).style.display = 'flex';
            if (layerId === 'question') {
                if (continueConversation != true) {
                    startChat();
                    console.log("new chat creating...")
                }
                fetchRemainingRequests(); // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–ª–æ—è 'question'
            }
            if (layerId === 'question2') {
                if (!continueConversation) {
                    startChat2();
                }
                fetchRemainingRequests2(); // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–ª–æ—è 'question'
            }
            if (layerId === 'profile') {
                fetchPremiumStatus();
            }
            if (layerId === 'menu') {
                chatId = null;
                chatId2 = null;
                continueConversation = false;
            }
        }

        function hideAll() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('question').style.display = 'none';
            document.getElementById('question2').style.display = 'none';
            document.getElementById('profile').style.display = 'none';
            document.getElementById('reply').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('cameralayer').style.display = 'none';
        }

        function sendEmail() {
            window.location.href = "https://bikmeev.github.io/support.html?id=" + idTg;
        }

        function openText(){
            localStorage.setItem('question', 'true');
            showLayer('question');
        }

        function validFileType(file) {
            return fileTypes.includes(file[0].type);
        }

        const selected = () =>{
            const fileName = document.createElement("p");
            error.appendChild(fileName);
            fileName.textContent = "–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ";
        }

        
        submit.addEventListener('click', () => {
            while (error.firstChild) {
                error.removeChild(error.firstChild);
            }
            const input = document.querySelector("input");
            input.style.opacity = 0;
            const para = document.createElement("p");
            error.appendChild(para);
            const file = input.files;
            if (file.length === 0) {
                para.textContent = "–§–∞–π–ª –Ω–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω.";
            } else{
                if (validFileType(file)) {
                    
                    document.getElementById('cameralayer').style.display = 'none';
                    document.getElementById('loading').style.display = 'flex';
                    const imageUrl = URL.createObjectURL(file[0]);
                    console.log(`Image URL: ${imageUrl}`);
                    fetch(imageUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        const formData = new FormData();
                        formData.append('file', blob, 'image.png');
                        return fetch('https://intelektusrv.ru:8000/recognize-text', {
                            method: 'POST',
                            body: formData,
                        });
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(`Received data:`, data);
                        localStorage.setItem('question2', 'true');
                        if(data.text === '\f' || data.text === ' \n\f'){
                            showLayer('question2');
                            showAlert("—Ç–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–æ–∑–Ω–∞–Ω");
                        }
                        else{
                            showLayer('question2');
                            const textarea = document.getElementById('userQuestion2');
                            textarea.value = data.text;
                        }
                    })
                    .catch(error => {
                            console.error('Error:', error);
                    });
                }else{
                    para.textContent = `File name ${file.name}: Not a valid file type. Update your selection.`;
                    error.appendChild(para);
                }
            }      
        });

        const cancelPremium = () => {

            isCharginAvailableByRulesVar = isCharginAvailableByRules();
            if (isCharginAvailableByRulesVar == "false"){
                showAlert("—Å–æ–≥–ª–∞—Å–Ω–æ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –ø—É–±–¥–∏—á–Ω–æ–π –æ—Ñ—Ñ–µ—Ä—Ç—ã (—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–π –ø–æ –≤–µ–± –∞–¥—Ä–µ—Å—É - https://intelektus.ru/pub-off-main.txt) –≤—ã –Ω–µ –º–æ–∂–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–∑–¥–Ω–µ–µ —á–µ–º 4 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –∏ –Ω–µ —Ä–∞–Ω—å—à–µ —á–µ–º 4 –¥–Ω—è —Å –Ω–∞—á–∞–ª–∞ –æ—Ñ–æ—Ä–º–¥–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏");
            } else{
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                var reversed_idTg = idTg.split("").reverse().join("");  // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º idTg
    
                var payload = {
                    user_id: idTg,
                    user_pass: reversed_idTg,
                };
            
                // –û–ø–ª–∞—Ç–∞
                var url = "https://intelektusrv.ru:8000/remove_cards";
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("loading").style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è
                    if (data.status === "success") {
                        console.log("cancelPremium", "true");
                        return "true";
                    } else {
                        console.log("cancelPremium", "false");
                        alert("–û—à–∏–±–∫–∞: " + data.reason);
                    }
                })
                .catch(error => {
                    document.getElementById("loading").style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É: " + error);
                });
            }
        }
        
        const isCharginAvailable = () => {
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                var idTgString = String(idTg);  // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É
                var reversed_idTg = idTgString.split("").reverse().join("");  // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É

                console.log("isCharginAvailable-idTgString", idTgString);
                console.log("isCharginAvailable-reversed_idTg", reversed_idTg);
    
                var payload = {
                    user_id: idTg,
                    user_pass: reversed_idTg,
                };
            
                // –û–ø–ª–∞—Ç–∞
                var url = "https://intelektusrv.ru:8000/recurrent_pay_available";
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Server Response:", data);  // –í—ã–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    document.getElementById("loading").style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è
                    if (data.status === "success") {
                        console.log("isCharginAvailable", "true");
                        return "true";
                    } else {
                        console.log("isCharginAvailable", "false");
                        return "false";
                    }
                })
                .catch(error => {
                    document.getElementById("loading").style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É: " + error);
                });
        }

        const isCharginAvailableByRules = () => {

            fetch(`https://intelektusrv.ru:8000/premium_end_date_br/${idTg}`, {
                    method: 'POST',
                })
                .then(response => {
                    console.log(response); // –í—ã–≤–æ–¥–∏—Ç –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    if (data.status === "success") {
                        if (data.days_left > 18 || data.days_left < 4) {
                            return "false";
                        } else {
                            return "true";
                        }
                    }
                    else if (data.status === "failed") {
                        showAlert("–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—É–ø–µ–Ω - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <–≤–µ—Ä–Ω—É—Ç—Å—è>");
                    }
                    else {
                        console.error(data.reason);
                    }
                })    
            }
        
 
    </script>
</body>
</html>
