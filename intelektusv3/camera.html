<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="cameraStyle.css">
    <title>Camera Capture 2/2</title>
</head>
<body>
    <div class="container">
        <p class="blue-box">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å </p>
        <div class="switch">
            <button class="text-switch" onclick="openText()">
                <p class="text-icon">ùêì</p>
                <p>–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç</p>
            </button>
            <button class="camera-switch">
                <img src="camera.svg">
                <p>–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</p>
            </button>
        </div>
        <video id="videoElement" autoplay></video>
        <button id="captureButton"></button>
    </div>
    <script>
        function openText(){
            localStorage.setItem('question', 'true');
            window.location.href='index.html';
        }
        
        const videoElement = document.getElementById('videoElement');
        const captureButton = document.getElementById('captureButton');
        const canvas = document.createElement('canvas'); // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç canvas
        const ctx = canvas.getContext('2d'); // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç 2D
        
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment'
            } 
        })
        .then((stream) => {
            videoElement.srcObject = stream;
        })
        .catch((err) => {
            console.log("Something went wrong!", err);
        });
        
        captureButton.addEventListener('click', () => {
            if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                const imageUrl = canvas.toDataURL('image/png');
                console.log(`Image URL: ${imageUrl}`);
                
                fetch(imageUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        const formData = new FormData();
                        formData.append('file', blob, 'image.png');
                        return fetch('https://intelektusrv.ru:8000/recognize-text', {
                            method: 'POST',
                            body: formData,
                        });
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(`Received data:`, data);
                        localStorage.setItem('question2', 'true');
                        if(data.text === '\f'){
                            localStorage.setItem('question2_data', "null");
                        }
                        else{
                            localStorage.setItem('question2_data', data.text);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            } else {
                console.log("Video stream is not ready.");
            }
        });

    </script>
</body>
</html>
